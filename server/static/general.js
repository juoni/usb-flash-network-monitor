// Generated by CoffeeScript 1.8.0
var actions_formatter, add_new_general_serial_number, add_new_machine, gebi, gebi_value, general_serials_url, get_machines, is_ip_correct, machines_url, prepare, process_machine_action_add_serial, process_machine_action_edit, process_machine_action_remove, register_serial_number, remove_general_serial, remove_general_serials, remove_machine, remove_machines, serials_url, unregister_serial, unregister_serial_formatter, update_general_serials_table, update_machine_serials, update_machines_table;

machines_url = "/ip";

general_serials_url = "/general";

serials_url = "/serial";

gebi = function(id) {
  return document.getElementById(id);
};

gebi_value = function(id) {
  return gebi(id).value;
};

is_ip_correct = function(ip) {
  return true;
};

update_machines_table = function() {
  get_machines();
};

unregister_serial = function(number) {
  $.ajax({
    url: serials_url + "/" + number,
    type: "DELETE",
    success: function(data) {
      data = JSON.parse(data);
      alert(data.message);
    }
  });
  update_machine_serials();
};

unregister_serial_formatter = function(value) {
  return "<a class='btn btn-primary' onclick='unregister_serial(\"" + value + "\")'>Unregister</a>\n";
};

update_machine_serials = function() {
  $.ajax({
    url: "/ip/" + $("#edit_machine_modal_form").attr("target"),
    type: "GET",
    success: function(data) {
      var rows;
      rows = [];
      data[0].special_serial_numbers.forEach(function(item, index, array) {
        rows.push({
          serial_number: item,
          actions: item
        });
      });
      $("#edit_machine_table").bootstrapTable("load", rows);
    }
  });
};

process_machine_action_edit = function(data) {
  $("#edit_machine_modal_form").attr("target", data);
  update_machine_serials();
  $("#edit_machine_modal_form").modal("show");
  get_machines();
};

register_serial_number = function() {
  var machine, number;
  machine = $("#add_serial_number_for_machine").attr("target");
  number = gebi_value("new_registered_serial_number");
  gebi("new_registered_serial_number").value = "";
  $.ajax({
    url: serials_url + "/" + machine,
    method: "PUT",
    data: {
      number: number
    },
    success: function(data) {
      alert("serial number " + number + " registered!");
    }
  });
};

process_machine_action_add_serial = function(data) {
  var target_form;
  target_form = $("#add_serial_number_for_machine");
  target_form.attr("target", data);
  target_form.modal("show");
};

process_machine_action_remove = function(data) {
  remove_machine(data);
  get_machines();
};

actions_formatter = function(value) {
  var actions, result;
  console.log("formatting " + value.actions);
  console.log(typeof value.actions);
  actions = value.actions;
  result = "";
  actions.forEach(function(item, index, array) {
    if (item === "edit") {
      result += "<a class='btn btn-primary' onclick='process_machine_action_" + item + "(\"" + value.item + "\")'>" + item + "</a>\n";
    } else if (item === "remove") {
      result += "<a class='btn btn-primary' onclick='process_machine_action_" + item + "(\"" + value.item + "\")'>" + item + "</a>\n";
    } else {
      if (item === "add_serial") {
        result += "<a class='btn btn-primary' onclick='process_machine_action_" + item + "(\"" + value.item + "\")'>" + item + "</a>\n";
      }
    }
  });
  return result;
};

get_machines = function() {
  $.ajax({
    url: machines_url,
    type: "GET",
    success: function(data) {
      var rows, table;
      rows = [];
      table = $("#machines_table");
      data.forEach(function(item, index, array) {
        var action_buttons;
        action_buttons = {
          item: item.ip_addr,
          actions: ["add_serial", "edit", "remove"]
        };
        rows.push({
          state: false,
          ip_addr: item.ip_addr,
          description: item.description,
          actions: action_buttons
        });
      });
      $("#machines_table").bootstrapTable("load", rows);
    }
  });
};

update_general_serials_table = function() {
  var table;
  table = $("#general_serials_table");
  table.bootstrapTable("refresh");
};

add_new_general_serial_number = function() {
  var input_element, number;
  number = gebi_value("general_serial_number");
  input_element = gebi("general_serial_number");
  input_element.value = "";
  $.ajax({
    url: general_serials_url,
    type: "PUT",
    data: {
      number: number
    },
    success: function(data) {
      update_general_serials_table();
    }
  });
};

add_new_machine = function() {
  var descr, ip;
  ip = gebi_value("machine_ip_address");
  gebi("machine_ip_address").value = "";
  descr = gebi_value("machine_description");
  gebi("machine_description").value = "";
  if (!is_ip_correct(ip)) {
    alert("IP is incorrect! Check it please");
  }
  $.ajax({
    url: machines_url,
    type: "PUT",
    data: {
      ip: ip,
      descr: descr
    },
    success: function(data) {
      update_machines_table();
    }
  });
};

remove_machines = function() {
  var selects, table;
  table = $("#machines_table");
  selects = table.bootstrapTable("getSelections");
  selects.forEach(function(item, index, array) {
    remove_machine(item.ip_addr);
  });
  update_machines_table();
};

remove_machine = function(ip) {
  $.ajax({
    url: machines_url,
    type: "DELETE",
    data: {
      ip: ip
    },
    success: function(data) {}
  });
};

remove_general_serials = function() {
  var selects, table;
  table = $("#general_serials_table");
  selects = table.bootstrapTable("getSelections");
  selects.forEach(function(item, index, array) {
    remove_general_serial(item.number);
  });
  update_general_serials_table();
};

remove_general_serial = function(number) {
  $.ajax({
    url: general_serials_url,
    type: "DELETE",
    data: {
      number: number
    },
    success: function(data) {}
  });
};

prepare = function() {
  update_machines_table();
  gebi("machine_button").onclick = add_new_machine;
  gebi("remove_machine_button").onclick = remove_machines;
  gebi("remove_general_serial_button").onclick = remove_general_serials;
  gebi("add_new_general_serial_button").onclick = add_new_general_serial_number;
  gebi("button_register_special_serial_number").onclick = register_serial_number;
};

window.onload = prepare;
